<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>모두의 자율학습, MOZA</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Nanum+Gothic&display=swap");
      * {
        font-family: "Nanum Gothic";
      }
      body {
        padding: 3%;
        font-weight: 700;
        height: 100%;
      }
      header {
        padding: 1%;
        margin-bottom: 3%;
        background-color: #1681ff;
        border-bottom: 2px solid #1681ff;
        font-size: 200%;
        margin-bottom: 1%;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      #addBlockButton {
        background-color: #ff9595;
        width: 10%;
        font-size: 150%;
        border-radius: 4px;
        border-color: transparent;
        margin-top: 1%;
        margin-bottom: 1%;
      }
      .chapter {
        background-color: white;
        color: #000000;
        width: 50%;
        font-size: 120%;
        border-radius: 4px;
        border-color: transparent;
        margin-top: 1%;
        top: 0;
        padding: 1%;
        text-align: left;
      }
      .contents {
        margin-top: 1%;
        margin-bottom: 3%;
        margin-left: 3%;
        background-color: white;
        color: #000000;
        width: 35%;
        font-size: 100%;
        border-color: transparent;
        top: 0;
        padding: 1%;
      }
      .container {
        position: relative;
        margin-top: 2%;
        margin-bottom: 2%;
        border: 2px solid;
        min-height: 200px;
        height: auto;
      }
      .block {
        background: #000000;
        width: 90%;
        min-height: 150px;
        box-shadow: 0px 4px 7.2px rgba(0, 0, 0, 0.25);
        border-radius: 20px;
        color: white;
        padding: 1%;
        padding-left: 2%;
        margin-top: 2%;
        margin-left: 4.5%;
        top: 0px;
        position: relative;
      }
      .correctionButton {
        width: 5%;
        height: auto;
        background: #ff9595;
        border-radius: 4px;
        color: white;
        padding: 1%;
        position: absolute;
        top: 60%;
        left: 40%;
        transform: translate(50%, -50%);
        text-align: center;
      }
      .deleteButton {
        width: 5%;
        height: auto;
        background: #ff9595;
        border-radius: 4px;
        color: white;
        padding: 1%;
        position: absolute;
        top: 80%;
        left: 40%;
        transform: translate(50%, -50%);
        text-align: center;
        cursor: pointer;
      }
      .quizBox {
        width: 48%;
        height: 100px; /* 고정된 높이 설정 */
        background: #1681ff;
        border-radius: 20px;
        color: white;
        padding: 10px;
        position: absolute;
        top: 13px;
        right: 22%;
        transform: translate(50%, -50%);
        overflow-y: auto; /* 수직 스크롤 추가 */
      }
      .quizTitle {
        background-color: white;
        color: black;
        padding: 1%;
        width: 30%;
        top: 100px;
        margin-top: 1%;
        margin-left: 5%;
      }
      .quizs {
        background-color: white;
        color: black;
        padding: 1%;
        width: 30%;
        top: 30%;
      }
      .quizBoxDeco {
        position: absolute;
        width: 0.8%;
        height: 80%;
        right: 5%;
        top: 13%;
        background: #000000;
        border-radius: 78px;
        z-index: 4;
        color: transparent;
      }
      .add-quiz {
        background-color: #ff9595;
        color: white;
        border: none;
        padding: 5px;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <header>
      <!-- <span class="subjectName" contenteditable="false">논리 회로와 설계</span> -->
      <span class="subjectName" id="subjectName" contenteditable="false"></span>
      <button id="editSubjectButton">과목 수정</button>
    </header>

    <button id="addBlockButton">+</button>
    <div id="blocksContainer"></div>

    <script>
      let num = 1;

      const recentId = localStorage.getItem("subjectId");
      if (recentId) {
        console.log("Success");
      } else {
        console.log("Fail");
      }

      document.addEventListener("DOMContentLoaded", function () {
        var subjectName = document.getElementById("subjectName");
        fetch(
          `https://apict.pnu.app/subject/{recentId}`
            .then((response) => {
              if (!response.ok) {
                throw new Error("안 괜찮아. 띵띵띵~");
              }
              return response.json();
            })
            .then((data) => {
              console.log("niceeee!");
              subjectName.textContent = data.title;
            })
            .catch((error) => {
              console.error("Not OK. 띵띵띵ㅠㅠㅠㅠㅠ", error);
            })
        );
      });

      document
        .getElementById("editSubjectButton")
        .addEventListener("click", function () {
          const subjectName = document.querySelector(".subjectName");
          if (subjectName.contentEditable === "false") {
            subjectName.contentEditable = "true";
            subjectName.focus();
            this.innerText = "저장";
          } else {
            subjectName.contentEditable = "false";
            this.innerText = "과목 수정";
          }
        });

      document
        .getElementById("addBlockButton")
        .addEventListener("click", function () {
          const container = document.getElementById("blocksContainer");
          const newBlock = document.createElement("div");
          newBlock.className = "container";
          newBlock.innerHTML = `
                <div class="block">
                    <div class="chapter" contenteditable="false">챕터명을 추가하세요</div>
                    <div class="contents" contenteditable="false">
                        <div class="content-item"><label><input type="checkbox" name="content1" value="option1">목차를 추가하세요.</label><button class="delete-content" style="display:none;">X</button></div>
                    </div>
                    <div class="correctionButton">수정</div>
                    <div class="deleteButton">삭제</div>
                    <div class="quizBox">
                        <div class="quizTitle">QUIZ</div>
                        <div class="quizs"></div>
                        <div class="quizBoxDeco">.</div>
                        <button class="add-quiz">문제 추가</button>
                    </div>
                    <button class="add-content" style="display:none;">+ 추가</button>
                </div>
            `;
          container.appendChild(newBlock);

          // 삭제 버튼 이벤트 리스너 추가
          newBlock
            .querySelector(".deleteButton")
            .addEventListener("click", function () {
              if (confirm("삭제하시겠습니까?")) {
                newBlock.remove();
              }
            });

          // 수정 버튼 이벤트 리스너 추가
          newBlock
            .querySelector(".correctionButton")
            .addEventListener("click", function () {
              const chapter = newBlock.querySelector(".chapter");
              const contents = newBlock.querySelector(".contents");
              const addContentButton = newBlock.querySelector(".add-content");
              const deleteContentButtons =
                newBlock.querySelectorAll(".delete-content");

              if (
                contents.getAttribute("data-editable") === "false" ||
                contents.getAttribute("data-editable") === null
              ) {
                chapter.contentEditable = "true";
                contents.setAttribute("data-editable", "true");
                addContentButton.style.display = "inline-block";
                deleteContentButtons.forEach((button) => {
                  button.style.display = "inline-block"; // Ensure buttons are visible in edit mode
                });

                // Make only text content editable
                contents.querySelectorAll(".content-item").forEach((item) => {
                  item.querySelectorAll("label").forEach((label) => {
                    const textNode = document.createTextNode(label.innerText);
                    label.innerHTML = "";
                    label.appendChild(textNode);
                  });
                  item.contentEditable = "true";
                });

                this.innerText = "저장";
              } else {
                chapter.contentEditable = "false";
                contents.setAttribute("data-editable", "false");
                addContentButton.style.display = "none";
                deleteContentButtons.forEach((button) => {
                  button.style.display = "none"; // Hide buttons when not in edit mode
                });

                // Disable text content editing
                contents.querySelectorAll(".content-item").forEach((item) => {
                  item.querySelectorAll("label").forEach((label) => {
                    const text = label.innerText;
                    label.innerHTML = `<input type="checkbox"> ${text}`;
                  });
                  item.contentEditable = "false";
                });

                this.innerText = "수정";
              }
            });

          // 추가 버튼 이벤트 리스너 추가
          newBlock
            .querySelector(".add-content")
            .addEventListener("click", function () {
              const contents = newBlock.querySelector(".contents");
              const newContent = document.createElement("div");
              newContent.className = "content-item";
              newContent.innerHTML = `<label><input type="checkbox" name="content-new" value="new"> <span contenteditable='true'> </span></label><button class="delete-content" style="display: inline-block;">X</button>`;
              contents.appendChild(newContent);

              // 개별 삭제 버튼 이벤트 리스너 추가
              newContent
                .querySelector(".delete-content")
                .addEventListener("click", function () {
                  newContent.remove();
                });

              // 더블 클릭으로 아이템 제거 추가
              newContent.addEventListener("dblclick", function () {
                // 사용자에게 삭제 확인 요청
                if (confirm("이 항목을 삭제하시겠습니까?")) {
                  newContent.remove();
                }
              });
              newContent.querySelector("span").focus();
            });
          // 초기 삭제 버튼 이벤트 리스너 추가
          newBlock.querySelectorAll(".delete-content").forEach((button) => {
            // 일반 클릭 이벤트
            button.addEventListener("click", function () {
              button.parentElement.remove();
            });

            // 더블 클릭 이벤트를 부모 요소에 추가
            button.parentElement.addEventListener("dblclick", function () {
              // 사용자에게 삭제를 확인
              if (confirm("이 항목을 삭제하시겠습니까?")) {
                this.remove(); // this는 클릭된 요소의 부모 요소를 참조
              }
            });
          });

          // 문제 추가 버튼 이벤트 리스너 추가
          newBlock
            .querySelector(".add-quiz")
            .addEventListener("click", function () {
              const quizs = newBlock.querySelector(".quizs");
              const newQuiz = document.createElement("div");
              const subjectName =
                document.querySelector(".subjectName").innerText;
              const chapter = newBlock.querySelector(".chapter").innerText;
              const contents = Array.from(
                newBlock.querySelectorAll(".content-item label")
              ).map((label) => label.innerText.trim());

              //newQuiz.innerHTML = `<a href="${subjectName}${num}mainQuiz.html" target="_blank">Quiz ${num}</a>`;
              newQuiz.innerHTML = `<a href="mainQuiz.html" target="_blank">Quiz ${num}</a>`;
              quizs.appendChild(newQuiz);
              num++;

              // JSON 파일 생성
              const data = {
                subjectId: 0,
                subjectName: subjectName,
                chapter: chapter,
                contents: contents,
              };

              const jsonBlob = new Blob([JSON.stringify(data, null, 2)], {
                type: "application/json",
              });
              const url = URL.createObjectURL(jsonBlob);

              // JSON 파일 전송 (여기서는 다운로드 링크 생성)
              const link = document.createElement("a");
              link.href = url;
              link.download = `${subjectName}${num}mainQuiz.json`;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              URL.revokeObjectURL(url);
            });
        });
    </script>
  </body>
</html>
