<!DOCTYPE html>
<html lang="kor">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>모두의 자율학습, MOZA</title>
    <link rel="import" href="mainCourse.html" />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Nanum+Gothic&display=swap");
      header {
        /* border: 2px solid pink; */
        margin-bottom: 3%;
        font-size: 200%;
        font-family: "Nanum Gothic";
        font-weight: 700;
      }
      body {
        padding: 3% 5%;
        font-family: "Nanum Gothic";
        font-weight: 400;
        /* background-image: url("./assets/background-main.gif");
        background-size: cover; */
      }
      .quizTemplate {
        /* border: 2px solid purple; */
        border-radius: 20px;
        height: 150%;
        overflow: hidden;
        background-color: #ebf5f9;
        box-shadow: 0px 4px 7.2px rgba(0, 0, 0, 0.25);
        margin-bottom: 40px;
      }

      .quizNumber {
        font-weight: 700;
        /* border: 2px solid black; */
        border-radius: 15px;
        box-shadow: 0px 4px 7.2px rgba(0, 0, 0, 0.25);
        font-size: 150%;
        width: 7%;
        height: 70px;
        float: left;
        margin-top: 20px;
        margin-left: 20px;
        color: #1681ff;
        background-color: white;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .quizSpec {
        /* border: 2px solid red; */
        margin-top: 20px;
        margin-left: 20px;
        width: 75%;
        float: left;
        margin-bottom: 20px;
      }
      .quizQuest {
        /* border: 2px solid green; */
        box-shadow: 0px 4px 7.2px rgba(0, 0, 0, 0.25);
        width: auto;
        border-radius: 10px;
        font-size: 120%;
        padding: 1.5%;
        line-height: 130%;
        background-color: rgba(255, 255, 255, 0.8);
      }
      .quizAnswer {
        /* border: 2px solid blue; */
        box-shadow: 0px 4px 7.2px rgba(0, 0, 0, 0.25);
        border-radius: 10px;
        border: none;
        width: 100%;
        box-sizing: border-box;
        margin-top: 15px;
        font-size: 120%;
        padding: 1.2%;
        line-height: 130%;
        outline: none;
        font-family: "Nanum Gothic";
        background-color: (225, 225, 225, 0.8);
      }

      .ansJudge {
        box-shadow: 0px 4px 7.2px rgba(0, 0, 0, 0.25);
        width: auto;
        border-radius: 5px;
        font-size: 120%;
        padding: 1.5%;
        line-height: 130%;
        background-color: rgba(255, 255, 255, 0.8);
      }
      .quizSol {
        box-shadow: 0px 4px 7.2px rgba(0, 0, 0, 0.25);
        width: auto;
        border-radius: 5px;
        font-size: 120%;
        padding: 1.5%;
        line-height: 130%;
        background-color: rgba(255, 255, 255, 0.8);
      }

      .quizButton {
        /* border: 2px solid black; */
        margin-top: 20px;
        margin-right: 20px;
        float: right;
        justify-content: center;
        text-align: right;
        width: 11%;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      button:active {
        box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.2);
      }
      button {
        border-radius: 20px;
        width: 100%;
        height: 50px;
        box-shadow: 0px 4px 7.2px rgba(0, 0, 0, 0.25);
        border: none;
        font-size: 130%;
        color: white;
        background-color: #ff8b8be3;
      }
      button:hover {
        cursor: pointer;
      }
      #answerSubmit {
        background-color: #ff8b8be3;
      }
      #showSolve {
        background-color: #1683ffa4;
      }
    </style>
  </head>
  <body>
    <div id="quizHeader"></div>
    <div id="quizContainer"></div>

    <script>
      const title = "mainCourse에서 받아올 제목";
      const quizNumber = "NO.";
      const quizExample = "API에서 넘어올 문제";

      document.addEventListener("DOMContentLoaded", function () {
        // 1. 헤더 렌더링 하기
        createHeader(title);
        const urlParams = new URLSearchParams(window.location.search);
        const quizId = urlParams.get("id");
        console.log("quiz_id: ", quizId);
        // 2. 서버에서 스토리지 젤 최근 subjectId 값 가지고 서버에서 json data 받기
        // const recentId = localStorage.getItem("quiz_id");
        // if (recentId) {
        //   console.log("quiz_id: ", recentId);
        // } else {
        //   console.log("quiz_id 다시 갖고 와.");
        // }

        var recentjsonData = "{ 'quiz_id': " + quizId + " }";
        // var recentjsonData = "{ 'quiz_id': 12 }";
        fetch(`https://apict.pnu.app/subject/chapter/quiz/${quizId}`, {
          // fetch("https://apict.pnu.app/subject/chapter/quiz/12", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include",
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("네트워크 응답이 옳지 않습니다.");
              // console.log("recentId: ", recentId);
            }
            return response.json();
          })
          .then((data) => {
            console.log("성공적인 응답: ", data);
            // 3. 받은 데이터를 이용하여 컴포넌트 생성하기
            createComponent(data);
          });
        createComponent(jsonData);
      });

      function createHeader(subject) {
        var header = document.createElement("header");
        header.textContent = subject + " 시험지";
        document.body.insertBefore(header, document.body.firstChild);
      }

      function createComponent(data) {
        var quizHeader = document.getElementById("quizHeader");
        var quizIndex = 1;
        data.problem.slice(0, 5).forEach(function (item) {
          var quizTemplate = document.createElement("div");
          quizTemplate.classList.add("quizTemplate");

          var quizNumber = document.createElement("div");
          quizNumber.classList.add("quizNumber");
          quizNumber.textContent = quizIndex++;

          var quizSpec = document.createElement("div");
          quizSpec.classList.add("quizSpec");

          var quizQuest = document.createElement("div");
          quizQuest.classList.add("quizQuest");
          quizQuest.textContent = item.question.replace(/<br>/g, "<br>");

          var quizAnswer = document.createElement("textarea");
          quizAnswer.classList.add("quizAnswer");
          quizAnswer.placeholder = "답변 입력 칸";

          var quizButton = document.createElement("div");
          quizButton.classList.add("quizButton");

          var answerSubmit = document.createElement("button");
          answerSubmit.setAttribute("id", "answerSubmit");
          answerSubmit.textContent = "제출하기";
          answerSubmit.addEventListener("click", function () {
            var answerVal = quizAnswer.value;
            var problemId = item.id;
            var jsonData = "{ 'user_answer': " + answerVal + " }";
            // var jsonData = {
            //   user_answer: answerVal,
            // };
            fetch(`https://apict.pnu.app/problem/${jsonData.problemId}`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(jsonData),
            })
              .then((response) => {
                if (!response.ok) {
                  throw new Error("네트워크 응답이 옳지 않습니다.");
                  console.log("problemId: ", problemId);
                }
                return response.json();
              })
              .then((data) => {
                console.log("성공적인 응답: ", data);
                var ansJudge = document.createElement("div");
                ansJudge.classList.add("ansJudge");
                var judgeTF = JSON.stringfy(data.is_correct);
                if (judgeTF == "true") {
                  judgeTF = "정답입니다.";
                } else {
                  judgeTF = "오답입니다.";
                }
                ansJudge.textContent = judgeTF;
                quizSpec.appendChild(ansJudge);
              })
              .catch((error) => {
                console.error("실패한 응답: ", error);
                console.log("problemId: ", problemId);
              });
          });

          var showSolve = document.createElement("button");
          showSolve.setAttribute("id", "showSolve");
          showSolve.textContent = "풀이보기";
          showSolve.addEventListener("click", function () {
            var quizId = item.id;
            var jsonData = "{ 'id': " + quizId + " }";
            // var jsonData = {
            //   id: quizId,
            // };
            fetch(`https://apict.pnu.app/solution/${jsonData.quizId}`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(jsonData),
            })
              .then((response) => {
                if (!response.ok) {
                  throw new Error("네트워크 응답이 옳지 않습니다.");
                  console.log("quizId: ", quizId);
                }
                return response.json();
              })
              .then((data) => {
                console.log("성공적인 응답: ", data);
                var quizSol = document.createElement("div");
                quizSol.classList.add("quizSol");
                var sol = JSON.stringify(data.solution);
                quizSol.textContent = sol;
                quizSpec.appendChild(quizSol);
              })
              .catch((error) => {
                console.error("실패한 응답: ", error);
                console.log("quizId: ", quizId);
              });
          });

          quizSpec.appendChild(quizQuest);
          quizSpec.appendChild(quizAnswer);

          quizButton.appendChild(answerSubmit);
          quizButton.appendChild(showSolve);

          quizTemplate.appendChild(quizNumber);
          quizTemplate.appendChild(quizSpec);
          quizTemplate.appendChild(quizButton);

          quizContainer.appendChild(quizTemplate);
        });
      }
    </script>
  </body>
</html>
